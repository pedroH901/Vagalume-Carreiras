{% extends 'base.html' %}
{% load static %}

{% block title %}Meu Dashboard{% endblock %}

{% block content %}

<style>
    /* =========================================
       1. LAYOUT GERAL & SLIDER
       ========================================= */
    main.main-container { display: block; padding: 20px 0; width: 100%; max-width: 100%; overflow-x: hidden; }
    
    .hero { text-align: center; padding: 40px 20px; min-height: 180px; display: flex; flex-direction: column; justify-content: center; }
    .hero h1 { font-size: clamp(2rem, 5vw, 2.5rem); margin-bottom: 10px; color: #fff; }
    .hero h1 .username { color: #BEF264; }
    .hero p { color: #94a3b8; font-size: 1.1rem; }
    .popup-info { color: #BEF264; font-size: 1rem; margin-top: 10px; }
    
    .tabs { display: flex; justify-content: center; gap: 30px; margin-bottom: 40px; border-bottom: 1px solid #30363d; }
    .tab { background: none; border: none; color: #94a3b8; font-size: 1rem; padding: 15px 20px; cursor: pointer; position: relative; font-family: 'Plus Jakarta Sans', sans-serif; transition: color 0.3s ease; }
    .tab:hover { color: #fff; }
    .tab.active { color: #fff; font-weight: 700; }
    .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background-color: #BEF264; }
    
    .dashboard-window { width: 100%; position: relative; overflow: hidden; min-height: 600px; }
    .dashboard-slider { display: flex; width: 300%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); } /* Ajustado para 300% */
    .panel { width: 33.33%; flex-shrink: 0; box-sizing: border-box; padding: 0 20px; } /* Ajustado para 1/3 */
    
    .show-tab-0 { transform: translateX(0); }
    .show-tab-1 { transform: translateX(-33.33%); }
    .show-tab-2 { transform: translateX(-66.66%); }

    /* =========================================
       2. CARDS DE VAGAS
       ========================================= */
    .container { max-width: 1200px; margin: 0 auto; }
    .jobs-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
    .job-card { background: #111111; border: 1px solid #1e293b; border-radius: 12px; padding: 25px; transition: transform 0.2s; position: relative; background-image: url("{% static 'vagas/img/vagalume_icon.png' %}"); background-repeat: no-repeat; background-position: right -10px bottom -10px; background-size: 150px; }
    .job-card:hover { transform: translateY(-5px); border-color: #2d3f52; }
    .tags { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
    .tag { padding: 4px 12px; background-color: rgba(255, 255, 255, 0.05); border: 1px solid #2d3f52; border-radius: 20px; font-size: 0.8rem; color: #94a3b8; }
    .job-title { color: #fff; margin-bottom: 5px; font-size: 1.3rem; font-weight: 600; }
    .company { color: #64748b; font-size: 0.95rem; margin-bottom: 20px; display: block; }
    .job-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
    .apply-btn { background: #AFEB83; color: #0D1B2A; border: none; padding: 10px 24px; border-radius: 6px; font-weight: 700; cursor: pointer; transition: 0.3s; }
    .apply-btn:hover { background: #BEF264; transform: scale(1.05); }
    .candidates { display: flex; align-items: center; gap: 5px; color: #64748b; font-size: 0.9rem; }
    .candidates svg { width: 16px; height: 16px; }

    /* =========================================
       3. PERFIL & CURRÍCULO
       ========================================= */
    .perfil-container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1.5fr; gap: 30px; }
    .perfil-box { background: #111111; border: 1px solid #1e293b; border-radius: 12px; padding: 30px; position: relative; overflow: hidden; height: fit-content; }
    .perfil-box h2 { color: #fff; margin-bottom: 25px; border-bottom: 1px solid #30363d; padding-bottom: 15px; font-size: 1.5rem; }

    /* Formulário Edição */
    .perfil-form label { display: block; color: #c9d1d9; font-weight: 600; margin-bottom: 8px; font-size: 0.95rem; }
    .perfil-form input, .perfil-form select { width: 100%; padding: 12px; background: #0D1B2A; border: 1px solid #30363d; color: #fff; border-radius: 6px; margin-bottom: 20px; font-family: inherit; transition: border-color 0.3s; }
    .perfil-form input:focus { border-color: #BEF264; outline: none; }
    .btn-save { width: 100%; background: #BEF264; color: #0D1B2A; font-weight: 800; padding: 14px; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px; font-size: 1rem; transition: background-color 0.3s; }
    .btn-save:hover { background-color: #a7e052; }

    /* Currículo Visual */
    .cv-section { margin-bottom: 30px; position: relative; }
    .cv-section h3 { color: #BEF264; font-size: 1.1rem; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
    .edit-hint { color: #64748b; font-size: 0.75rem; font-style: italic; margin-bottom: 8px; opacity: 0; transition: opacity 0.3s; }
    .cv-section:hover .edit-hint { opacity: 1; }
    .cv-content { color: #c9d1d9; font-size: 1rem; line-height: 1.6; padding: 12px; border-radius: 6px; transition: all 0.3s; cursor: pointer; min-height: 40px; border: 1px solid transparent; }
    .cv-content:hover { background: rgba(190, 242, 100, 0.05); border-color: #30363d; }
    .editable-textarea { width: 100%; background: #0D1B2A; border: 2px solid #BEF264; color: #fff; padding: 12px; border-radius: 6px; font-family: inherit; font-size: 1rem; line-height: 1.6; resize: vertical; min-height: 120px; margin-bottom: 10px; }
    .save-cancel-btns { display: none; gap: 10px; margin-top: 10px; }
    .save-cancel-btns.active { display: flex; }
    .btn-cancel { background: transparent; border: 1px solid #30363d; color: #c9d1d9; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 700; }
    .btn-cancel:hover { border-color: #ef4444; color: #ef4444; }

    /* Skills */
    .skill-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
    .skill-tag { display: inline-block; background: #2d3f52; color: #fff; padding: 6px 14px; border-radius: 20px; font-size: 0.9rem; border: 1px solid #30363d; transition: all 0.3s; cursor: pointer; position: relative; }
    .skill-tag:hover { border-color: #BEF264; color: #BEF264; padding-right: 28px; }
    .remove-skill { display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-weight: bold; font-size: 14px; }
    .skill-tag:hover .remove-skill { display: block; }
    
    .skill-input-wrapper { display: none; gap: 10px; margin-top: 10px; align-items: center; }
    .skill-input-wrapper.active { display: flex; }
    .skill-input { flex: 1; padding: 8px 12px; background: #0D1B2A; border: 1px solid #30363d; color: #fff; border-radius: 6px; }
    .add-skill-trigger { display: inline-block; color: #64748b; font-size: 0.9rem; cursor: pointer; padding: 4px 12px; border: 1px dashed #30363d; border-radius: 20px; transition: all 0.3s; }
    .add-skill-trigger:hover { color: #BEF264; border-color: #BEF264; }
    .add-skill-btn { background: #AFEB83; color: #0D1B2A; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; cursor: pointer; }

    /* Items XP/Edu */
    .xp-item, .edu-item { padding: 15px 20px 15px 20px; border-left: 3px solid #30363d; margin-bottom: 20px; position: relative; border-radius: 0 6px 6px 0; transition: all 0.3s; }
    .xp-item:hover, .edu-item:hover { background: rgba(190, 242, 100, 0.05); border-left-color: #BEF264; }
    .xp-item::before, .edu-item::before { content: ''; width: 12px; height: 12px; background: #BEF264; border-radius: 50%; position: absolute; left: -7.5px; top: 20px; }
    .xp-item strong, .edu-item strong { color: #fff; display: block; font-size: 1.1rem; margin-bottom: 4px; }
    .xp-item span, .edu-item span { color: #8b949e; font-size: 0.9rem; display: block; margin-bottom: 8px; }
    .xp-item p, .edu-item p { color: #c9d1d9; font-size: 0.95rem; }
    .item-actions { display: none; position: absolute; top: 10px; right: 10px; gap: 8px; }
    .xp-item:hover .item-actions, .edu-item:hover .item-actions { display: flex; }
    .action-btn { background: #2d3f52; color: #fff; border: none; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
    .action-btn:hover { background: #BEF264; color: #0D1B2A; }
    .action-btn.delete:hover { background: #ef4444; color: white; }

    .add-new-btn { display: inline-flex; align-items: center; gap: 8px; background: transparent; border: 1px dashed #30363d; color: #64748b; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin-top: 10px; width: 100%; justify-content: center; }
    .add-new-btn:hover { border-color: #BEF264; color: #BEF264; }

    /* =========================================
       4. FINANÇAS (ESTILO COSMÉTICO)
       ========================================= */
    .finance-controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 50px; flex-wrap: wrap; }
    .btn-pill { background: #BEF264; color: #0D1B2A; border: none; padding: 15px 30px; border-radius: 50px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; box-shadow: 0 4px 15px rgba(190, 242, 100, 0.15); }
    .btn-pill:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(190, 242, 100, 0.3); background: #d4ff8a; }

    .finance-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; max-width: 900px; margin: 0 auto; }
    .finance-card { background: linear-gradient(145deg, #e2fd92 0%, #bef264 100%); color: #0D1B2A; border-radius: 20px; height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 40px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; position: relative; overflow: hidden; }
    .finance-card:hover { transform: translateY(-10px) scale(1.02); box-shadow: 0 20px 40px rgba(190, 242, 100, 0.2); }
    .finance-card ul { list-style: none; padding: 0; }
    .finance-card li { font-size: 1.4rem; font-weight: 600; line-height: 1.4; }
    .finance-card li::before { content: '•'; margin-right: 10px; color: #0D1B2A; }
    
    /* Calculadora */
    .calc-result { margin-top: 20px; padding: 15px; background: #1a2e1e; border: 1px solid #BEF264; border-radius: 8px; color: #BEF264; font-weight: bold; display: none; }

    @media (max-width: 768px) {
        .finance-grid { grid-template-columns: 1fr; }
        .finance-card { height: 200px; }
    }

    /* =========================================
       5. MODAIS (POPUPS)
       ========================================= */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(13, 27, 42, 0.9); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-overlay.active { display: flex; }
    .modal-box { background: #161B22; padding: 40px; border-radius: 16px; border: 1px solid #30363d; width: 95%; max-width: 550px; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); animation: modalEntry 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes modalEntry { from { transform: translateY(20px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid #30363d; padding-bottom: 15px; }
    .modal-header h3 { color: #fff; margin: 0; font-size: 1.4rem; font-weight: 700; }
    .btn-close-modal { background: none; border: none; color: #64748b; font-size: 2rem; line-height: 1; cursor: pointer; transition: color 0.2s; }
    .btn-close-modal:hover { color: #ef4444; }
    
    /* Form Modais */
    .modal-form label { display: block; color: #c9d1d9; font-size: 0.9rem; font-weight: 600; margin-bottom: 8px; margin-top: 15px; }
    .modal-form input, .modal-form select, .modal-form textarea { width: 100%; background-color: #0d1117; border: 1px solid #30363d; color: #ffffff; padding: 12px 15px; border-radius: 8px; font-size: 0.95rem; font-family: inherit; transition: all 0.2s ease; box-sizing: border-box; }
    .modal-form input:focus, .modal-form select:focus, .modal-form textarea:focus { outline: none; border-color: #BEF264; box-shadow: 0 0 0 3px rgba(190, 242, 100, 0.1); background-color: #131d29; }
    .modal-form textarea { min-height: 120px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .modal-form .btn-save { margin-top: 25px; width: auto; float: right; background: #BEF264; color: #0D1B2A; padding: 10px 24px; border-radius: 6px; font-weight: 800; border: none; cursor: pointer; transition: transform 0.2s; }
    .modal-form .btn-save:hover { transform: scale(1.05); }
    .modal-actions .btn-cancel { background: transparent; border: 1px solid #30363d; color: #c9d1d9; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-right: 10px; }
    .modal-actions .btn-cancel:hover { border-color: #64748b; background: rgba(255,255,255,0.05); }

    /* Onboarding (Originais) */
    .onboarding-container { display: none; max-width: 600px; margin: 40px auto; padding: 40px; background: #1a2332; border-radius: 12px; text-align: center; border: 1px solid #30363d; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .onboarding-title { color: #fff; font-size: 2rem; margin-bottom: 10px; font-weight: 800; }
    .onboarding-subtitle { color: #8b949e; margin-bottom: 30px; font-size: 1.1rem; }
    .container-ativo { display: block; animation: fadeInUp 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    #progress-bar-fixed-wrapper { max-width: 600px; margin: 20px auto; }
    .progress-bar-wrapper { width: 100%; height: 8px; background: #0D1117; border-radius: 4px; overflow: hidden; }
    .progress-bar-fill { width: 0%; height: 100%; background: #AFEB83; transition: width 0.8s ease; }
    #progresso-texto { color: #BEF264; margin-bottom: 8px; text-align: right; font-weight: 700; }
    
    @media (max-width: 900px) {
        .perfil-container { grid-template-columns: 1fr; }
        .jobs-grid { grid-template-columns: 1fr; }
        .panel { padding: 0 10px; }
    }
</style>

<div id="progress-bar-fixed-wrapper" style="display: none;">
    <p id="progresso-texto">0%</p>
    <div class="progress-bar-wrapper"><div class="progress-bar-fill" id="progresso-barra"></div></div>
</div>

<div id="onboarding-wrapper" style="display: none;">
    <div class="onboarding-container" id="onboarding-step-1">
        <h1 class="onboarding-title">Bem-vindo(a)!</h1>
        <p class="onboarding-subtitle">Vamos configurar seu perfil.</p>
        <button id="btn-iniciar-onboarding" class="btn-save" style="width: auto; padding: 12px 40px;">Começar</button>
    </div>
    <div class="onboarding-container" id="onboarding-step-2">
        <h1 class="onboarding-title">Resumo</h1>
        <form id="form-step-2" action="{% url 'ajax_salvar_resumo' %}" method="POST">
            {% csrf_token %}
            <textarea name="resumo" style="width:100%; height:150px; background:#0a1929; color:white; border:1px solid #30363d; padding:10px;" placeholder="Seu resumo...">{{ texto_resumo }}</textarea>
            <div style="text-align: right;"><button type="submit" class="btn-save" style="width: auto;">Continuar</button></div>
        </form>
    </div>
    <div class="onboarding-container" id="onboarding-step-3">
        <h1 class="onboarding-title">Experiência</h1>
        <form id="form-step-3" action="{% url 'ajax_salvar_experiencia' %}" method="POST">
            {% csrf_token %} {{ experiencia_form.as_p }}
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="submit" name="salvar_outro" class="btn-save" style="background: transparent; border: 1px solid #30363d; color: #c9d1d9; width: auto;">+ Outra</button>
                <button type="submit" name="continuar" class="btn-save" style="width: auto;">Continuar</button>
            </div>
        </form>
        <div id="lista-experiencias" style="text-align: left; margin-top: 20px;"></div>
    </div>
    <div class="onboarding-container" id="onboarding-step-4">
        <h1 class="onboarding-title">Formação</h1>
        <form id="form-step-4" action="{% url 'ajax_salvar_formacao' %}" method="POST">
            {% csrf_token %} {{ formacao_form.as_p }}
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="submit" name="salvar_outro" class="btn-save" style="background: transparent; border: 1px solid #30363d; color: #c9d1d9; width: auto;">+ Outra</button>
                <button type="submit" name="continuar" class="btn-save" style="width: auto;">Continuar</button>
            </div>
        </form>
        <div id="lista-formacoes" style="text-align: left; margin-top: 20px;"></div>
    </div>
    <div class="onboarding-container" id="onboarding-step-5">
        <h1 class="onboarding-title">Skills</h1>
        <form id="form-step-5" action="{% url 'ajax_salvar_skill' %}" method="POST">
            {% csrf_token %} {{ skill_form.as_p }}
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="submit" name="salvar_outro" class="btn-save" style="background: transparent; border: 1px solid #30363d; color: #c9d1d9; width: auto;">+ Outra</button>
                <button type="submit" name="continuar" class="btn-save" style="width: auto;">Continuar</button>
            </div>
        </form>
        <div id="lista-skills" style="text-align: left; margin-top: 20px;"></div>
    </div>
    <div class="onboarding-container" id="onboarding-step-6">
        <h1 class="onboarding-title">Currículo PDF</h1>
        <form id="form-step-6" action="{% url 'ajax_salvar_curriculo' %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %} {{ curriculo_form.as_p }}
            <div style="text-align: right; margin-top: 20px;"><button type="submit" class="btn-save" style="width: auto;">Finalizar</button></div>
        </form>
    </div>
</div>

<div id="main-interface" class="dashboard-window">
    
    <section class="hero" id="dynamic-hero">
        <h1 id="hero-title">Olá, <span class="username">{{ user.first_name|default:user.username }}</span></h1>
        <p id="hero-subtitle">Confira as vagas recomendadas para você.</p>
        {% if messages %}{% for message in messages %}{% if 'FIRST_LOGIN' not in message.tags %}<div class="popup-info">{{ message }}</div>{% endif %}{% endfor %}{% endif %}
    </section>

    <div class="tabs" id="tabs-container">
        <button class="tab active" data-index="0">Recomendados</button>
        <button class="tab" data-index="1">Perfil</button>
        <button class="tab" data-index="2">Finança</button>
        <div class="tab-indicator" id="tab-indicator"></div>
    </div>

    <div class="dashboard-slider show-tab-0" id="slider">
        
        <div class="panel">
            <div class="container">
                <div class="jobs-grid">
                    {% for vaga in vagas %}
                    <div class="job-card">
                        <div class="tags"><span class="tag">{{ vaga.tipo_contrato }}</span><span class="tag">{{ vaga.localidade }}</span></div>
                        <h3 class="job-title">{{ vaga.titulo }}</h3>
                        <span class="company">{{ vaga.empresa.nome }}</span>
                        <div class="job-footer">
                            <div class="candidates"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>+12</div>
                            <form action="{% url 'aplicar_vaga' vaga.id %}" method="POST" style="margin:0;">{% csrf_token %}<button class="apply-btn">Candidatar</button></form>
                        </div>
                    </div>
                    {% empty %}<p style="color:#8b949e; grid-column: 1/-1; text-align: center; padding: 40px;">Nenhuma vaga encontrada.</p>{% endfor %}
                </div>
            </div>
        </div>

        <div class="panel inactive">
            <div class="perfil-container">
                <div class="perfil-box">
                    <h2>Editar Dados</h2>
                    <form method="POST" class="perfil-form">
                        {% csrf_token %}
                        {% if perfil_user_form %}{{ perfil_user_form.as_p }}{% else %}<label>Nome</label><input type="text" name="first_name" value="{{ user.first_name }}"><label>Sobrenome</label><input type="text" name="last_name" value="{{ user.last_name }}">{% endif %}
                        {% if perfil_candidato_form %}{{ perfil_candidato_form.as_p }}{% else %}<label>Headline</label><input type="text" name="headline" value="{{ user.candidato.headline }}">{% endif %}
                        <label>LinkedIn</label><input type="text" name="linkedin_fake" placeholder="URL do LinkedIn">
                        <button type="submit" class="btn-save">Salvar Alterações</button>
                    </form>
                </div>

                <div class="perfil-box">
                    <h2>Visualização do Currículo</h2>
                    <div class="cv-section">
                        <h3>Resumo Profissional</h3>
                        <div class="edit-hint">Clique para editar</div>
                        <div class="cv-content" id="resumo-content" data-field="resumo">{{ texto_resumo|default:"Clique para adicionar um resumo." }}</div>
                        <div class="save-cancel-btns" id="resumo-actions">
                            <button class="btn-save" onclick="saveResumo()" style="padding:6px 15px; width:auto;">Salvar</button>
                            <button class="btn-cancel" onclick="cancelEdit('resumo')" style="padding:6px 15px; width:auto;">Cancelar</button>
                        </div>
                    </div>

                    <div class="cv-section">
                        <h3>Habilidades (Hard Skills)</h3>
                        <div id="hard-skills-container" class="skill-list">
                            {% for skill in hard_skills %}
                                <span class="skill-tag" id="skill-{{ skill.id }}">{{ skill.nome }} <span class="remove-skill" onclick="removeSkill({{ skill.id }})">×</span></span>
                            {% endfor %}
                        </div>
                        <div class="add-skill-trigger" onclick="toggleSkillInput('hard')">+ Adicionar skill</div>
                        <div class="skill-input-wrapper" id="hard-skill-input">
                            <input type="text" class="skill-input" placeholder="Ex: Python" id="hard-skill-name">
                            <button class="add-skill-btn" onclick="addSkill('hard')">Salvar</button>
                        </div>
                    </div>

                    <div class="cv-section">
                        <h3>Habilidades (Soft Skills)</h3>
                        <div id="soft-skills-container" class="skill-list">
                            {% for skill in soft_skills %}
                                <span class="skill-tag" id="skill-{{ skill.id }}">{{ skill.nome }} <span class="remove-skill" onclick="removeSkill({{ skill.id }})">×</span></span>
                            {% endfor %}
                        </div>
                        <div class="add-skill-trigger" onclick="toggleSkillInput('soft')">+ Adicionar skill</div>
                        <div class="skill-input-wrapper" id="soft-skill-input">
                            <input type="text" class="skill-input" placeholder="Ex: Liderança" id="soft-skill-name">
                            <button class="add-skill-btn" onclick="addSkill('soft')">Salvar</button>
                        </div>
                    </div>

                    <div class="cv-section">
                        <h3>Experiência Profissional</h3>
                        <div id="experiencias-container">
                            {% for exp in experiencias %}
                                <div class="xp-item" id="xp-{{ exp.id }}">
                                    <div class="item-actions"><button class="action-btn delete" onclick="deleteItem('experiencia', {{ exp.id }})">Excluir</button></div>
                                    <strong>{{ exp.cargo }}</strong>
                                    <span>{{ exp.empresa }} | {{ exp.data_inicio|date:"Y" }}</span>
                                    <p>{{ exp.descricao|default:"" }}</p>
                                </div>
                            {% empty %}<span class="cv-content" style="font-size:0.9rem;">Nenhuma experiência registrada.</span>{% endfor %}
                        </div>
                        <button class="add-new-btn" onclick="abrirModal('modal-experiencia')"><span>+</span> Adicionar experiência</button>
                    </div>

                    <div class="cv-section">
                        <h3>Formação Acadêmica</h3>
                        <div id="formacoes-container">
                            {% for edu in formacoes %}
                                <div class="edu-item" id="edu-{{ edu.id }}">
                                    <div class="item-actions"><button class="action-btn delete" onclick="deleteItem('formacao', {{ edu.id }})">Excluir</button></div>
                                    <strong>{{ edu.nome_formacao }}</strong>
                                    <span>{{ edu.nome_instituicao }} ({{ edu.nivel }})</span>
                                </div>
                            {% empty %}<span class="cv-content" style="font-size:0.9rem;">Nenhuma formação registrada.</span>{% endfor %}
                        </div>
                        <button class="add-new-btn" onclick="abrirModal('modal-formacao')"><span>+</span> Adicionar formação</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel inactive">
            
            <div class="finance-controls">
                <button class="btn-pill" onclick="abrirModal('modal-calculadora')">Calculadora de Salário Líquido</button>
                <button class="btn-pill" onclick="abrirModalInfo('Orçamento')">Dicas de Orçamento Pessoal</button>
                <button class="btn-pill" onclick="abrirModalInfo('Benefícios')">Benefícios Trabalhistas Explicados</button>
            </div>

            <div class="finance-grid">
                <div class="finance-card" onclick="abrirModalInfo('Primeiro Salário')">
                    <ul><li>Como organizar o primeiro salário</li></ul>
                </div>
                <div class="finance-card" onclick="abrirModalInfo('Emergência')">
                    <ul><li>Planejamento para emergências</li></ul>
                </div>
                <div class="finance-card" onclick="abrirModalInfo('Contracheque')">
                    <ul><li>Entendendo descontos no contracheque</li></ul>
                </div>
                <div class="finance-card" onclick="abrirModalInfo('FGTS')">
                    <ul><li>Guia rápido sobre FGTS e 13º</li></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-experiencia" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><h3>Nova Experiência</h3><button class="btn-close-modal" onclick="fecharModal('modal-experiencia')">&times;</button></div>
        <form action="{% url 'ajax_salvar_experiencia' %}" method="POST" class="modal-form dashboard-ajax-form">
            {% csrf_token %} {{ experiencia_form.as_p }}
            <div style="text-align: right; margin-top: 20px;"><button type="submit" class="btn-save" style="width: auto;">Salvar</button></div>
        </form>
    </div>
</div>

<div id="modal-formacao" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><h3>Nova Formação</h3><button class="btn-close-modal" onclick="fecharModal('modal-formacao')">&times;</button></div>
        <form action="{% url 'ajax_salvar_formacao' %}" method="POST" class="modal-form dashboard-ajax-form">
            {% csrf_token %} {{ formacao_form.as_p }}
            <div style="text-align: right; margin-top: 20px;"><button type="submit" class="btn-save" style="width: auto;">Salvar</button></div>
        </form>
    </div>
</div>

<div id="modal-calculadora" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><h3>Calculadora Salário Líquido</h3><button class="btn-close-modal" onclick="fecharModal('modal-calculadora')">&times;</button></div>
        <div class="modal-form">
            <label>Salário Bruto (R$)</label>
            <input type="number" id="calc-bruto" placeholder="Ex: 3000">
            
            <label>Número de Dependentes</label>
            <input type="number" id="calc-dep" placeholder="0">

            <button class="btn-save" onclick="calcularSalario()" style="width: 100%; margin-top: 20px;">Calcular Agora</button>

            <div id="calc-resultado" class="calc-result" style="margin-top: 20px; padding: 15px; background: #1a2e1e; border: 1px solid #BEF264; border-radius: 8px; color: #BEF264; font-weight: bold; display: none;">
                Salário Líquido Estimado: <span id="valor-liquido" style="font-size: 1.2rem; color: #fff;">R$ 0,00</span>
            </div>
        </div>
    </div>
</div>

<div id="modal-info-financa" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><h3 id="info-title">Título</h3><button class="btn-close-modal" onclick="fecharModal('modal-info-financa')">&times;</button></div>
        <div id="info-content" style="color: #c9d1d9; line-height: 1.6;">Texto aqui...</div>
    </div>
</div>

<script>
// --- DADOS E SLIDER ---
const panelData=[{title:'Olá, <span class="username">{{ user.first_name|default:user.username }}</span>',subtitle:'Confira as vagas recomendadas para você.'},{title:'Meu Perfil',subtitle:'Gerencie seus dados e visualização do currículo.'},{title:'Finanças do candidato',subtitle:'Organize seu dinheiro e tome decisões melhores para o seu futuro profissional.'}];
const slider=document.getElementById('slider'),tabs=document.querySelectorAll('.tab'),indicator=document.getElementById('tab-indicator'),hero=document.getElementById('dynamic-hero'),heroTitle=document.getElementById('hero-title'),heroSubtitle=document.getElementById('hero-subtitle'),panels=document.querySelectorAll('.panel');
let currentTab=0;

function updateIndicator(tab){const rect=tab.getBoundingClientRect(),containerRect=tab.parentElement.getBoundingClientRect();indicator.style.width=rect.width+'px';indicator.style.left=(rect.left-containerRect.left)+'px'}
function updateHero(index){hero.classList.add('transitioning');setTimeout(()=>{heroTitle.innerHTML=panelData[index].title;heroSubtitle.textContent=panelData[index].subtitle;hero.classList.remove('transitioning')},300)}
function goToTab(index){if(index===currentTab)return;tabs.forEach(tab=>tab.classList.remove('active'));tabs[index].classList.add('active');updateIndicator(tabs[index]);slider.className='dashboard-slider show-tab-'+index;panels.forEach((panel,i)=>{i===index?panel.classList.remove('inactive'):panel.classList.add('inactive')});updateHero(index);window.scrollTo({top:0,behavior:'smooth'});currentTab=index; localStorage.setItem('activeTab', index);}
tabs.forEach((tab,index)=>{tab.addEventListener('click',()=>goToTab(index))});
window.addEventListener('load',()=>{const savedTab=localStorage.getItem('activeTab');if(savedTab&&parseInt(savedTab)<3){goToTab(parseInt(savedTab))}else{updateIndicator(tabs[0])}});
window.addEventListener('resize',()=>{updateIndicator(tabs[currentTab])});

// --- INFO FINANÇAS ---
const infoData = {
    'Orçamento': '<p>A regra 50-30-20 é um ótimo começo:</p><ul><li>50% para necessidades (aluguel, comida)</li><li>30% para desejos (lazer, hobbies)</li><li>20% para poupança e dívidas</li></ul><p>Use apps ou planilhas para rastrear cada centavo.</p>',
    'Benefícios': '<p><strong>Vale Transporte:</strong> Obrigatório se você usa transporte público. Desconto de até 6%.</p><p><strong>VR/VA:</strong> Não é obrigatório por lei, mas comum.</p><p><strong>Plano de Saúde:</strong> A empresa pode descontar uma parte.</p>',
    'Primeiro Salário': '<p>Não gaste tudo de uma vez! Priorize:</p><ol><li>Pagar dívidas pendentes.</li><li>Criar uma reserva de emergência.</li><li>Investir em cursos para crescer.</li></ol>',
    'Emergência': '<p>Sua reserva deve cobrir de 3 a 6 meses do seu custo de vida.</p><p>Guarde em um local com liquidez diária (que você pode sacar a qualquer momento), como Tesouro Selic ou CDBs.</p>',
    'Contracheque': '<p>Principais descontos:</p><ul><li><strong>INSS:</strong> Aposentadoria (7.5% a 14%)</li><li><strong>IRRF:</strong> Imposto de Renda (Isento até R$2.259)</li><li><strong>VT:</strong> Até 6% do salário base</li></ul>',
    'FGTS': '<p><strong>FGTS:</strong> A empresa deposita 8% do seu salário em uma conta. Você só saca se for demitido sem justa causa.</p><p><strong>13º Salário:</strong> Pago em duas parcelas (Nov e Dez). É um salário extra proporcional aos meses trabalhados.</p>'
};

function abrirModalInfo(chave) {
    document.getElementById('info-title').textContent = chave;
    document.getElementById('info-content').innerHTML = infoData[chave] || "Informação não disponível.";
    abrirModal('modal-info-financa');
}

// --- CALCULADORA SIMPLES (JS) ---
function calcularSalario() {
    const bruto = parseFloat(document.getElementById('calc-bruto').value);
    const deps = parseInt(document.getElementById('calc-dep').value) || 0;
    if(!bruto) return;

    // 1. INSS (Tabela 2024 aprox)
    let inss = 0;
    if (bruto <= 1412) inss = bruto * 0.075;
    else if (bruto <= 2666) inss = (bruto * 0.09) - 21.18;
    else if (bruto <= 4000) inss = (bruto * 0.12) - 101.18;
    else if (bruto <= 7786) inss = (bruto * 0.14) - 181.18;
    else inss = 908.85; // Teto

    // 2. Base IRRF
    let baseIrrf = bruto - inss - (deps * 189.59);
    
    // 3. IRRF (Tabela 2024 aprox)
    let irrf = 0;
    if (baseIrrf <= 2259) irrf = 0;
    else if (baseIrrf <= 2826) irrf = (baseIrrf * 0.075) - 169.44;
    else if (baseIrrf <= 3751) irrf = (baseIrrf * 0.15) - 381.44;
    else if (baseIrrf <= 4664) irrf = (baseIrrf * 0.225) - 662.77;
    else irrf = (baseIrrf * 0.275) - 896.00;

    if(irrf < 0) irrf = 0;

    const liquido = bruto - inss - irrf;

    document.getElementById('valor-liquido').innerText = liquido.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    document.getElementById('calc-resultado').style.display = 'block';
}

// --- UTILITÁRIOS CSRF ---
function getCookie(name){let cookieValue=null;if(document.cookie&&document.cookie!==''){const cookies=document.cookie.split(';');for(let i=0;i<cookies.length;i++){const cookie=cookies[i].trim();if(cookie.substring(0,name.length+1)===(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break}}}return cookieValue}
const csrftoken=getCookie('csrftoken');

// --- LÓGICA DE MODAIS ---
function abrirModal(id) { 
    const modal = document.getElementById(id);
    modal.style.display = 'flex';
    setTimeout(() => { modal.classList.add('active'); }, 10);
    document.body.style.overflow = 'hidden';
}
function fecharModal(id) { 
    const modal = document.getElementById(id);
    modal.classList.remove('active');
    setTimeout(() => { modal.style.display = 'none'; document.body.style.overflow = ''; }, 300);
}
window.onclick = function(e) { if(e.target.classList.contains('modal-overlay')) fecharModal(e.target.id); }

// --- AJAX PARA MODAIS (XP/EDU) ---
document.querySelectorAll('.dashboard-ajax-form').forEach(form => {
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const btn = this.querySelector('button[type="submit"]');
        btn.innerText = "Salvando..."; btn.disabled = true;
        try {
            const response = await fetch(this.action, { method: 'POST', body: formData, headers: {'X-CSRFToken': csrftoken} });
            const data = await response.json();
            if (data.status === 'success') window.location.reload();
            else { alert('Erro: ' + JSON.stringify(data.errors)); btn.innerText = "Salvar"; btn.disabled = false; }
        } catch (e) { console.error(e); }
    });
});

// --- LÓGICA DO CURRÍCULO INTERATIVO ---
function makeEditable(f){const c=document.getElementById(f+'-content'),a=document.getElementById(f+'-actions');if(c.style.display==='none')return;const t=document.createElement('textarea');t.id=f+'-textarea';t.className='editable-textarea';t.value=c.innerText.trim();c.style.display='none';c.parentNode.insertBefore(t,c.nextSibling);a.style.display='flex';t.focus()}
function cancelEdit(f){const t=document.getElementById(f+'-textarea'),c=document.getElementById(f+'-content'),a=document.getElementById(f+'-actions');if(t)t.remove();c.style.display='block';a.style.display='none'}
async function saveResumo(){const val=document.getElementById('resumo-textarea').value;const fd=new FormData();fd.append('resumo',val);try{const r=await fetch("{% url 'ajax_salvar_resumo' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken},body:fd});const d=await r.json();if(d.status==='success'){document.getElementById('resumo-content').innerText=val;cancelEdit('resumo')}}catch(e){console.error(e)}}
document.getElementById('resumo-content').addEventListener('click',()=>makeEditable('resumo'));

// Skills
function toggleSkillInput(t){const w=document.getElementById(t+'-skill-input');w.style.display=w.style.display==='flex'?'none':'flex'}
async function addSkill(type){const input=document.getElementById(type+'-skill-name');if(!input.value)return;const fd=new FormData();fd.append('nome',input.value);fd.append('tipo',type);try{await fetch("{% url 'ajax_salvar_skill' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken},body:fd});window.location.reload()}catch(e){console.error(e)}}
async function removeSkill(id){if(!confirm("Remover?"))return;try{await fetch(`/contas/ajax/deletar-skill/${id}/`,{method:'DELETE',headers:{'X-CSRFToken':csrftoken}});document.getElementById('skill-'+id).remove()}catch(e){console.error(e)}}

// Delete Item
async function deleteItem(type,id){if(!confirm("Excluir?"))return;const url=type==='experiencia'?`/contas/ajax/deletar-experiencia/${id}/`:`/contas/ajax/deletar-formacao/${id}/`;try{const r=await fetch(url,{method:'DELETE',headers:{'X-CSRFToken':csrftoken}});if(r.ok)document.getElementById((type==='experiencia'?'xp-':'edu-')+id).remove()}catch(e){console.error(e)}}

// --- ONBOARDING ---
const mainInterface=document.getElementById('main-interface'),onboardingWrapper=document.getElementById('onboarding-wrapper');
document.addEventListener('DOMContentLoaded',function(){
async function enviarFormulario(form,botaoPressionado){const url=form.action,formData=new FormData(form);if(botaoPressionado)formData.append(botaoPressionado.name,botaoPressionado.value);try{const response=await fetch(url,{method:'POST',body:formData,headers:{'X-CSRFToken':form.querySelector('[name=csrfmiddlewaretoken]').value}});const data=await response.json();if(data.status==='success'){if(data.action==='next_step')return true;const lista=document.getElementById(data.list_id);if(lista&&data.saved_item_html)lista.innerHTML+=data.saved_item_html;form.reset();return false}else{let msg='Erro no formulário.';if(data.errors)msg=JSON.stringify(data.errors);alert(msg);return false}}catch(e){console.error(e);alert('Erro de conexão.');return false}}
const steps=[document.getElementById('onboarding-step-1'),document.getElementById('onboarding-step-2'),document.getElementById('onboarding-step-3'),document.getElementById('onboarding-step-4'),document.getElementById('onboarding-step-5'),document.getElementById('onboarding-step-6')];
function showStep(index){steps.forEach((s,i)=>{s.style.display=i===index?'block':'none';if(i===index)s.classList.add('container-ativo')});const progress=document.getElementById('progresso-barra'),progressTxt=document.getElementById('progresso-texto'),pct=Math.round(((index+1)/steps.length)*100);if(progress)progress.style.width=pct+'%';if(progressTxt)progressTxt.innerText=pct+'%'}
let isFirstLogin=false;{% if messages %}{% for message in messages %}{% if 'FIRST_LOGIN' in message.tags %}isFirstLogin=true;{% endif %}{% endfor %}{% endif %}
if(isFirstLogin){mainInterface.style.display='none';document.getElementById('progress-bar-fixed-wrapper').style.display='block';onboardingWrapper.style.display='block';showStep(0);document.getElementById('btn-iniciar-onboarding').onclick=()=>showStep(1);document.getElementById('form-step-2').onsubmit=async(e)=>{e.preventDefault();if(await enviarFormulario(e.target,e.submitter))showStep(2)};document.getElementById('form-step-3').onsubmit=async(e)=>{e.preventDefault();if(e.submitter.name==='continuar'&&!e.target.querySelector('[name=cargo]').value){showStep(3);return}if(await enviarFormulario(e.target,e.submitter))showStep(3)};document.getElementById('form-step-4').onsubmit=async(e)=>{e.preventDefault();if(e.submitter.name==='continuar'&&!e.target.querySelector('[name=nome_formacao]').value){showStep(4);return}if(await enviarFormulario(e.target,e.submitter))showStep(4)};document.getElementById('form-step-5').onsubmit=async(e)=>{e.preventDefault();if(e.submitter.name==='continuar'&&!e.target.querySelector('[name=nome]').value){showStep(5);return}if(await enviarFormulario(e.target,e.submitter))showStep(5)};document.getElementById('form-step-6').onsubmit=async(e)=>{e.preventDefault();if(await enviarFormulario(e.target,e.submitter)){onboardingWrapper.style.display='none';document.getElementById('progress-bar-fixed-wrapper').style.display='none';mainInterface.style.display='block';goToTab(0)}}}else{onboardingWrapper.style.display='none';mainInterface.style.display='block'}});
</script>

{% endblock %}
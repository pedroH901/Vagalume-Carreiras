{% extends 'base.html' %}
{% load static %}

{% block title %}Meu Dashboard{% endblock %}

{% block content %}



<div id="progress-bar-fixed-wrapper" style="display: none;">
    <p id="progresso-texto">0%</p>
    <div class="progress-bar-wrapper"><div class="progress-bar-fill" id="progresso-barra"></div></div>
</div>

<div id="onboarding-wrapper" style="display: none;">
    <div class="onboarding-container" id="onboarding-step-1">
        <h1 class="onboarding-title">Bem-vindo(a)!</h1>
        <p class="onboarding-subtitle">Vamos configurar seu perfil.</p>
        <button id="btn-iniciar-onboarding" class="btn-save" style="width: auto; padding: 12px 40px;">Começar</button>
    </div>
    <div class="onboarding-container" id="onboarding-step-2">
        <h1 class="onboarding-title">Resumo</h1>
        <form id="form-step-2" action="{% url 'ajax_salvar_resumo' %}" method="POST">
            {% csrf_token %}
            <textarea name="resumo" style="width:100%; height:150px; background:#0a1929; color:white; border:1px solid #30363d; padding:10px;" placeholder="Seu resumo...">{{ texto_resumo }}</textarea>
            <div style="text-align: right;"><button type="submit" class="btn-save" style="width: auto;">Continuar</button></div>
        </form>
    </div>
    <div class="onboarding-container" id="onboarding-step-3">
        <h1 class="onboarding-title">Experiência</h1>
        <form id="form-step-3" action="{% url 'ajax_salvar_experiencia' %}" method="POST">
            {% csrf_token %} {{ experiencia_form.as_p }}
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="submit" name="salvar_outro" class="btn-save" style="background: transparent; border: 1px solid #30363d; color: #c9d1d9; width: auto;">+ Outra</button>
                <button type="submit" name="continuar" class="btn-save" style="width: auto;">Continuar</button>
            </div>
        </form>
        <div id="lista-experiencias" style="text-align: left; margin-top: 20px;"></div>
    </div>
    <div class="onboarding-container" id="onboarding-step-4">
        <h1 class="onboarding-title">Formação</h1>
        <form id="form-step-4" action="{% url 'ajax_salvar_formacao' %}" method="POST">
            {% csrf_token %} {{ formacao_form.as_p }}
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="submit" name="salvar_outro" class="btn-save" style="background: transparent; border: 1px solid #30363d; color: #c9d1d9; width: auto;">+ Outra</button>
                <button type="submit" name="continuar" class="btn-save" style="width: auto;">Continuar</button>
            </div>
        </form>
        <div id="lista-formacoes" style="text-align: left; margin-top: 20px;"></div>
    </div>
    
    <div class="onboarding-container" id="onboarding-step-5">
        <h1 class="onboarding-title">Suas Skills</h1>
        <p class="onboarding-subtitle">Clique nas sugestões abaixo para preencher rápido.</p>
        
        <form id="form-step-5" action="{% url 'ajax_salvar_skill' %}" method="POST" class="custom-form-style">
            {% csrf_token %} 
            
            {{ skill_form.as_p }}

            <label class="sugestao-titulo">Sugestões Rápidas:</label>
            
            <div class="tag-cloud-box">
                <div class="skill-tag-btn" onclick="preencherSkill('Python', 'hard')">Python</div>
                <div class="skill-tag-btn" onclick="preencherSkill('JavaScript', 'hard')">JavaScript</div>
                <div class="skill-tag-btn" onclick="preencherSkill('SQL', 'hard')">SQL</div>
                <div class="skill-tag-btn" onclick="preencherSkill('React', 'hard')">React</div>
                <div class="skill-tag-btn" onclick="preencherSkill('Django', 'hard')">Django</div>
                <div class="skill-tag-btn" onclick="preencherSkill('Excel', 'hard')">Excel</div>
                <div class="skill-tag-btn" onclick="preencherSkill('Inglês', 'hard')">Inglês</div>
                
                <div class="tag-separator"></div>
                
                <div class="skill-tag-btn" onclick="preencherSkill('Liderança', 'soft')">Liderança</div>
                <div class="skill-tag-btn" onclick="preencherSkill('Comunicação', 'soft')">Comunicação</div>
                <div class="skill-tag-btn" onclick="preencherSkill('Proatividade', 'soft')">Proatividade</div>
                <div class="skill-tag-btn" onclick="preencherSkill('Organização', 'soft')">Organização</div>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="submit" name="salvar_outro" class="btn-save" style="background: transparent; border: 1px solid #30363d; color: #c9d1d9; width: auto;">+ Salvar e Adicionar Outra</button>
                <button type="submit" name="continuar" class="btn-save" style="width: auto;">Continuar</button>
            </div>
        </form>
        
        <div id="lista-skills" style="text-align: left; margin-top: 20px;"></div>
    </div>

    <div class="onboarding-container" id="onboarding-step-6">
        <h1 class="onboarding-title">Currículo PDF</h1>
        <form id="form-step-6" action="{% url 'ajax_salvar_curriculo' %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %} {{ curriculo_form.as_p }}
            <div style="text-align: right; margin-top: 20px;"><button type="submit" class="btn-save" style="width: auto;">Finalizar</button></div>
        </form>
    </div>
</div>

<div id="main-interface" class="dashboard-window">
    
    <section class="hero" id="dynamic-hero">
        <h1 id="hero-title">Olá, <span class="username">{{ user.first_name|default:user.username }}</span></h1>
        <p id="hero-subtitle">Confira as vagas recomendadas para você.</p>
        
        {% if messages %}
            {% for message in messages %}
                {% if 'FIRST_LOGIN' not in message.tags %}
                    <div class="popup-info">{{ message }}</div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </section>

    <div class="tabs" id="tabs-container">
        <button class="tab active" data-index="0">Recomendados</button>
        <button class="tab" data-index="1">Perfil</button>
        <button class="tab" data-index="2">Finança</button>
        <div class="tab-indicator" id="tab-indicator"></div>
    </div>

    <div class="dashboard-slider show-tab-0" id="slider">
        
        <div class="panel active-panel">
            <div class="container">
                <div class="jobs-grid">
                    {% for vaga in vagas %}
                    <div class="job-card">
                        <div class="tags"><span class="tag">{{ vaga.tipo_contrato }}</span><span class="tag">{{ vaga.localidade }}</span></div>
                        <h3 class="job-title">{{ vaga.titulo }}</h3>
                        <span class="company">{{ vaga.empresa.nome }}</span>
                        <div class="job-footer">
                            <div class="candidates"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg>+12</div>
                            <form action="{% url 'aplicar_vaga' vaga.id %}" method="POST" style="margin:0;">{% csrf_token %}<button class="apply-btn">Candidatar</button></form>
                        </div>
                    </div>
                    {% empty %}<p style="color:#8b949e; grid-column: 1/-1; text-align: center; padding: 40px;">Nenhuma vaga encontrada.</p>{% endfor %}
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="perfil-container">
                <div class="perfil-box">
                    <h2>Editar Dados</h2>
                    <form method="POST" class="perfil-form">
                        {% csrf_token %}
                        {% if perfil_user_form %}{{ perfil_user_form.as_p }}{% else %}<label>Nome</label><input type="text" name="first_name" value="{{ user.first_name }}"><label>Sobrenome</label><input type="text" name="last_name" value="{{ user.last_name }}">{% endif %}
                        {% if perfil_candidato_form %}{{ perfil_candidato_form.as_p }}{% else %}<label>Headline</label><input type="text" name="headline" value="{{ user.candidato.headline }}">{% endif %}
                        <label>LinkedIn</label><input type="text" name="linkedin_fake" placeholder="URL do LinkedIn">
                        <button type="submit" class="btn-save">Salvar Alterações</button>
                    </form>
                </div>

                <div class="perfil-box">
                    <h2>Visualização do Currículo</h2>
                    
                    <div style="text-align: center;">
                        <button onclick="pedirAnaliseIA()" class="btn-ia-glow">
                            ✨ Vagalume AI: Analisar meu Perfil
                        </button>
                    </div>

                    <div class="cv-section">
                        <h3>Resumo Profissional</h3>
                        <div class="edit-hint">Clique para editar</div>
                        <div class="cv-content" id="resumo-content" data-field="resumo">{{ texto_resumo|default:"Clique para adicionar um resumo." }}</div>
                        <div class="save-cancel-btns" id="resumo-actions">
                            <button class="btn-save" onclick="saveResumo()" style="padding:6px 15px; width:auto;">Salvar</button>
                            <button class="btn-cancel" onclick="cancelEdit('resumo')" style="padding:6px 15px; width:auto;">Cancelar</button>
                        </div>
                    </div>

                    <div class="cv-section">
                        <h3>Habilidades (Hard Skills)</h3>
                        <div id="hard-skills-container" class="skill-list">
                            {% for skill in hard_skills %}
                                <span class="skill-tag" id="skill-{{ skill.id }}">{{ skill.nome }} <span class="remove-skill" onclick="removeSkill({{ skill.id }})">×</span></span>
                            {% endfor %}
                        </div>
                        <div class="add-skill-trigger" onclick="toggleSkillInput('hard')">+ Adicionar skill</div>
                        <div class="skill-input-wrapper" id="hard-skill-input">
                            <input type="text" class="skill-input" placeholder="Ex: Python" id="hard-skill-name">
                            <button class="add-skill-btn" onclick="addSkill('hard')">Salvar</button>
                        </div>
                    </div>

                    <div class="cv-section">
                        <h3>Habilidades (Soft Skills)</h3>
                        <div id="soft-skills-container" class="skill-list">
                            {% for skill in soft_skills %}
                                <span class="skill-tag" id="skill-{{ skill.id }}">{{ skill.nome }} <span class="remove-skill" onclick="removeSkill({{ skill.id }})">×</span></span>
                            {% endfor %}
                        </div>
                        <div class="add-skill-trigger" onclick="toggleSkillInput('soft')">+ Adicionar skill</div>
                        <div class="skill-input-wrapper" id="soft-skill-input">
                            <input type="text" class="skill-input" placeholder="Ex: Liderança" id="soft-skill-name">
                            <button class="add-skill-btn" onclick="addSkill('soft')">Salvar</button>
                        </div>
                    </div>

                    <div class="cv-section">
                        <h3>Experiência Profissional</h3>
                        <div id="experiencias-container">
                            {% for exp in experiencias %}
                                <div class="xp-item" id="xp-{{ exp.id }}">
                                    <div style="float:right;"><button class="action-btn delete" onclick="deleteItem('experiencia', {{ exp.id }})">Excluir</button></div>
                                    <strong>{{ exp.cargo }}</strong>
                                    <span>{{ exp.empresa }} | {{ exp.data_inicio|date:"Y" }}</span>
                                    <p>{{ exp.descricao|default:"" }}</p>
                                </div>
                            {% empty %}<span class="cv-content" style="font-size:0.9rem;">Nenhuma experiência registrada.</span>{% endfor %}
                        </div>
                        <button class="add-new-btn" onclick="abrirModal('modal-experiencia')"><span>+</span> Adicionar experiência</button>
                    </div>

                    <div class="cv-section">
                        <h3>Formação Acadêmica</h3>
                        <div id="formacoes-container">
                            {% for edu in formacoes %}
                                <div class="edu-item" id="edu-{{ edu.id }}">
                                    <div style="float:right;"><button class="action-btn delete" onclick="deleteItem('formacao', {{ edu.id }})">Excluir</button></div>
                                    <strong>{{ edu.nome_formacao }}</strong>
                                    <span>{{ edu.nome_instituicao }} ({{ edu.nivel }})</span>
                                </div>
                            {% empty %}<span class="cv-content" style="font-size:0.9rem;">Nenhuma formação registrada.</span>{% endfor %}
                        </div>
                        <button class="add-new-btn" onclick="abrirModal('modal-formacao')"><span>+</span> Adicionar formação</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="finance-controls">
                <button class="btn-pill" onclick="abrirModal('modal-calculadora')">Calculadora de Salário Líquido</button>
                <button class="btn-pill" onclick="abrirModalInfo('Orçamento')">Dicas de Orçamento</button>
                <button class="btn-pill" onclick="abrirModalInfo('Benefícios')">Benefícios Trabalhistas</button>
            </div>
            <div class="finance-grid">
                <div class="finance-card" onclick="abrirModalInfo('Primeiro Salário')"><ul><li>Como organizar o primeiro salário</li></ul></div>
                <div class="finance-card" onclick="abrirModalInfo('Emergência')"><ul><li>Planejamento para emergências</li></ul></div>
                <div class="finance-card" onclick="abrirModalInfo('Contracheque')"><ul><li>Entendendo descontos no contracheque</li></ul></div>
                <div class="finance-card" onclick="abrirModalInfo('FGTS')"><ul><li>Guia rápido sobre FGTS e 13º</li></ul></div>
            </div>
        </div>
    </div>
</div>

<div id="modal-experiencia" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><h3>Nova Experiência</h3><button class="btn-close-modal" onclick="fecharModal('modal-experiencia')">&times;</button></div>
        <form action="{% url 'ajax_salvar_experiencia' %}" method="POST" class="modal-form dashboard-ajax-form">
            {% csrf_token %} {{ experiencia_form.as_p }}
            <div style="text-align: right; margin-top: 20px;"><button type="submit" class="btn-save" style="width: auto;">Salvar</button></div>
        </form>
    </div>
</div>

<div id="modal-formacao" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><h3>Nova Formação</h3><button class="btn-close-modal" onclick="fecharModal('modal-formacao')">&times;</button></div>
        <form action="{% url 'ajax_salvar_formacao' %}" method="POST" class="modal-form dashboard-ajax-form">
            {% csrf_token %} {{ formacao_form.as_p }}
            <div style="text-align: right; margin-top: 20px;"><button type="submit" class="btn-save" style="width: auto;">Salvar</button></div>
        </form>
    </div>
</div>

<div id="modal-calculadora" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><h3>Calculadora Salário Líquido</h3><button class="btn-close-modal" onclick="fecharModal('modal-calculadora')">&times;</button></div>
        <div class="modal-form">
            <label>Salário Bruto (R$)</label>
            <input type="number" id="calc-bruto" placeholder="Ex: 3000">
            <label>Número de Dependentes</label>
            <input type="number" id="calc-dep" placeholder="0">
            <button class="btn-save" onclick="calcularSalario()" style="width: 100%; margin-top: 20px;">Calcular Agora</button>
            <div id="calc-resultado" class="calc-result" style="margin-top: 20px; padding: 15px; background: #1a2e1e; border: 1px solid #BEF264; border-radius: 8px; color: #BEF264; font-weight: bold; display: none;">
                Salário Líquido Estimado: <span id="valor-liquido" style="font-size: 1.2rem; color: #fff;">R$ 0,00</span>
            </div>
        </div>
    </div>
</div>

<div id="modal-info-financa" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header"><h3 id="info-title">Título</h3><button class="btn-close-modal" onclick="fecharModal('modal-info-financa')">&times;</button></div>
        <div id="info-content" style="color: #c9d1d9; line-height: 1.6;">Texto aqui...</div>
    </div>
</div>

<div id="modal-ia-result" class="modal-overlay">
    <div class="modal-box" style="border: 2px solid #BEF264; max-width: 600px;">
        <div class="modal-header">
            <h3 style="color:#BEF264">✨ Análise Vagalume AI</h3>
            <button class="btn-close-modal" onclick="fecharModal('modal-ia-result')">&times;</button>
        </div>
        <div style="text-align: center; margin-bottom: 20px;">
            <i class="fas fa-robot" style="font-size: 3rem; color: #BEF264;"></i>
        </div>
        <div id="ia-content" style="color: #c9d1d9; line-height: 1.8; font-size: 1.05rem; text-align: left;"></div>
        <div style="margin-top: 25px; text-align: right;">
            <button onclick="fecharModal('modal-ia-result')" class="btn-save" style="width: auto;">Entendi</button>
        </div>
    </div>
</div>

<script>
    // --- LÓGICA DO SLIDER ---
    const panelData = [
        {title: 'Olá, <span class="username">{{ user.first_name|default:user.username }}</span>', subtitle: 'Confira as vagas recomendadas para você.'},
        {title: 'Meu Perfil', subtitle: 'Gerencie seus dados e visualização do currículo.'},
        {title: 'Finanças do candidato', subtitle: 'Organize seu dinheiro e tome decisões melhores.'}
    ];
    const slider=document.getElementById('slider'),tabs=document.querySelectorAll('.tab'),indicator=document.getElementById('tab-indicator'),heroTitle=document.getElementById('hero-title'),heroSubtitle=document.getElementById('hero-subtitle'),panels=document.querySelectorAll('.panel');
    let currentTab=0;

    function updateIndicator(tab){
        const rect=tab.getBoundingClientRect();
        const containerRect=tab.parentElement.getBoundingClientRect();
        indicator.style.width=rect.width+'px';
        indicator.style.left=(rect.left-containerRect.left)+'px';
    }

    function goToTab(index){
        if(index===currentTab)return;
        tabs.forEach(t=>t.classList.remove('active')); tabs[index].classList.add('active');
        updateIndicator(tabs[index]);
        slider.style.transform=`translateX(-${index*33.33}%)`;
        panels.forEach((p,i)=>{if(i===index)p.classList.add('active-panel');else p.classList.remove('active-panel')});
        heroTitle.innerHTML=panelData[index].title; heroSubtitle.textContent=panelData[index].subtitle;
        localStorage.setItem('candidateTab', index); currentTab=index;
    }

    tabs.forEach((tab,i)=>tab.addEventListener('click',()=>goToTab(i)));

    window.addEventListener('load',()=>{
        const saved=localStorage.getItem('candidateTab');
        slider.classList.add('no-transition');
        if(saved && parseInt(saved)<3){ goToTab(parseInt(saved)); } else { updateIndicator(tabs[0]); }
        setTimeout(()=>slider.classList.remove('no-transition'),100);
        setTimeout(() => { document.querySelectorAll('.popup-info').forEach(el => { el.style.opacity='0'; setTimeout(()=>el.remove(),500); }); }, 4000);
    });
    window.addEventListener('resize',()=>updateIndicator(tabs[currentTab]));

    // --- SCRIPT DA IA ---
    async function pedirAnaliseIA() {
        const btn = document.querySelector('.btn-ia-glow');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisando...'; btn.disabled = true;
        
        try {
            const response = await fetch("{% url 'ajax_analise_ia_perfil' %}", {
                method: 'POST', headers: {'X-CSRFToken': "{{ csrf_token }}"}
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                document.getElementById('ia-content').innerHTML = data.dicas;
                abrirModal('modal-ia-result');
            } else {
                alert("Ops! " + data.message);
            }
        } catch (e) {
            console.error(e); alert("Erro de conexão com o Vagalume AI.");
        } finally {
            btn.innerHTML = originalText; btn.disabled = false;
        }
    }

    // --- AJAX PARA MODAIS (XP/EDU) ---
    document.querySelectorAll('.dashboard-ajax-form').forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const btn = this.querySelector('button[type="submit"]');
            const originalText = btn.innerText;
            btn.innerText = "Salvando..."; 
            btn.disabled = true;
            
            let token = formData.get('csrfmiddlewaretoken');
            if (!token) token = getCookie('csrftoken');

            try {
                const response = await fetch(this.action, { 
                    method: 'POST', 
                    body: formData, 
                    headers: {'X-CSRFToken': token} 
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    window.location.reload();
                } else { 
                    alert('Erro: ' + JSON.stringify(data.errors)); 
                    btn.innerText = originalText; 
                    btn.disabled = false; 
                }
            } catch (e) { 
                console.error(e);
                alert("Erro de conexão.");
                btn.innerText = originalText; 
                btn.disabled = false; 
            }
        });
    });

    // --- GERAIS ---
    function abrirModal(id) { const m=document.getElementById(id); m.style.display='flex'; setTimeout(()=>m.classList.add('active'),10); }
    function fecharModal(id) { const m=document.getElementById(id); m.classList.remove('active'); setTimeout(()=>m.style.display='none',300); }
    window.onclick=function(e){ if(e.target.classList.contains('modal-overlay')) fecharModal(e.target.id); }

    function getCookie(name){let cookieValue=null;if(document.cookie&&document.cookie!==''){const cookies=document.cookie.split(';');for(let i=0;i<cookies.length;i++){const cookie=cookies[i].trim();if(cookie.substring(0,name.length+1)===(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break}}}return cookieValue}
    const csrftoken=getCookie('csrftoken');

    function makeEditable(f){const c=document.getElementById(f+'-content'),a=document.getElementById(f+'-actions');if(c.style.display==='none')return;const t=document.createElement('textarea');t.id=f+'-textarea';t.className='editable-textarea';t.value=c.innerText.trim();c.style.display='none';c.parentNode.insertBefore(t,c.nextSibling);a.style.display='flex';t.focus()}
    function cancelEdit(f){const t=document.getElementById(f+'-textarea'),c=document.getElementById(f+'-content'),a=document.getElementById(f+'-actions');if(t)t.remove();c.style.display='block';a.style.display='none'}
    async function saveResumo(){const val=document.getElementById('resumo-textarea').value;const fd=new FormData();fd.append('resumo',val);try{const r=await fetch("{% url 'ajax_salvar_resumo' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken},body:fd});const d=await r.json();if(d.status==='success'){document.getElementById('resumo-content').innerText=val;cancelEdit('resumo')}}catch(e){console.error(e)}}
    document.getElementById('resumo-content').addEventListener('click',()=>makeEditable('resumo'));

    function toggleSkillInput(t){const w=document.getElementById(t+'-skill-input');w.style.display=w.style.display==='flex'?'none':'flex'; if(w.style.display==='flex') w.querySelector('input').focus();}
    async function addSkill(type){const input=document.getElementById(type+'-skill-name');if(!input.value)return;const fd=new FormData();fd.append('nome',input.value);fd.append('tipo',type);try{await fetch("{% url 'ajax_salvar_skill' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken},body:fd});window.location.reload()}catch(e){console.error(e)}}
    async function removeSkill(id){if(!confirm("Remover?"))return;try{await fetch(`/contas/ajax/deletar-skill/${id}/`,{method:'DELETE',headers:{'X-CSRFToken':csrftoken}});document.getElementById('skill-'+id).remove()}catch(e){console.error(e)}}
    async function deleteItem(type,id){if(!confirm("Excluir?"))return;const url=type==='experiencia'?`/contas/ajax/deletar-experiencia/${id}/`:`/contas/ajax/deletar-formacao/${id}/`;try{const r=await fetch(url,{method:'DELETE',headers:{'X-CSRFToken':csrftoken}});if(r.ok)document.getElementById((type==='experiencia'?'xp-':'edu-')+id).remove()}catch(e){console.error(e)}}

    // Info Finanças
    const infoData = {
        'Orçamento': '<p>Regra 50-30-20: 50% Essencial, 30% Desejos, 20% Poupança.</p>',
        'Primeiro Salário': '<p>Priorize pagar dívidas e criar reserva de emergência.</p>',
        'Emergência': '<p>3 a 6 meses de custo de vida.</p>',
        'Contracheque': '<p>Descontos comuns: INSS, IRRF, Vale Transporte.</p>',
        'FGTS': '<p>8% do salário depositado pela empresa. Saque em demissão sem justa causa.</p>'
    };
    function abrirModalInfo(k){document.getElementById('info-title').textContent=k;document.getElementById('info-content').innerHTML=infoData[k]||"Indisponível.";abrirModal('modal-info-financa');}
    function calcularSalario(){const b=parseFloat(document.getElementById('calc-bruto').value),d=parseInt(document.getElementById('calc-dep').value)||0;if(!b)return;let i=0;if(b<=1412)i=b*0.075;else if(b<=2666)i=b*0.09-21.18;else if(b<=4000)i=b*0.12-101.18;else if(b<=7786)i=b*0.14-181.18;else i=908.85;let bi=b-i-(d*189.59),ir=0;if(bi>2259){if(bi<=2826)ir=bi*0.075-169.44;else if(bi<=3751)ir=bi*0.15-381.44;else if(bi<=4664)ir=bi*0.225-662.77;else ir=bi*0.275-896.00}if(ir<0)ir=0;document.getElementById('valor-liquido').innerText=(b-i-ir).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});document.getElementById('calc-resultado').style.display='block';}
    
    // ONBOARDING LOGIC
    const mainInterface=document.getElementById('main-interface'),onboardingWrapper=document.getElementById('onboarding-wrapper');
    document.addEventListener('DOMContentLoaded',function(){
        async function enviarFormulario(form,botaoPressionado){const url=form.action,formData=new FormData(form);if(botaoPressionado)formData.append(botaoPressionado.name,botaoPressionado.value);try{const response=await fetch(url,{method:'POST',body:formData,headers:{'X-CSRFToken':form.querySelector('[name=csrfmiddlewaretoken]').value}});const data=await response.json();if(data.status==='success'){if(data.action==='next_step')return true;const lista=document.getElementById(data.list_id);if(lista&&data.saved_item_html)lista.innerHTML+=data.saved_item_html;form.reset();return false}else{let msg='Erro no formulário.';if(data.errors)msg=JSON.stringify(data.errors);alert(msg);return false}}catch(e){console.error(e);alert('Erro de conexão.');return false}}
        const steps=[document.getElementById('onboarding-step-1'),document.getElementById('onboarding-step-2'),document.getElementById('onboarding-step-3'),document.getElementById('onboarding-step-4'),document.getElementById('onboarding-step-5'),document.getElementById('onboarding-step-6')];
        function showStep(index){steps.forEach((s,i)=>{s.style.display=i===index?'block':'none';if(i===index)s.classList.add('container-ativo')});const progress=document.getElementById('progresso-barra'),progressTxt=document.getElementById('progresso-texto'),pct=Math.round(((index+1)/steps.length)*100);if(progress)progress.style.width=pct+'%';if(progressTxt)progressTxt.innerText=pct+'%'}
        let isFirstLogin=false;{% if messages %}{% for message in messages %}{% if 'FIRST_LOGIN' in message.tags %}isFirstLogin=true;{% endif %}{% endfor %}{% endif %}
        if(isFirstLogin){mainInterface.style.display='none';document.getElementById('progress-bar-fixed-wrapper').style.display='block';onboardingWrapper.style.display='block';showStep(0);document.getElementById('btn-iniciar-onboarding').onclick=()=>showStep(1);document.getElementById('form-step-2').onsubmit=async(e)=>{e.preventDefault();if(await enviarFormulario(e.target,e.submitter))showStep(2)};document.getElementById('form-step-3').onsubmit=async(e)=>{e.preventDefault();if(e.submitter.name==='continuar'&&!e.target.querySelector('[name=cargo]').value){showStep(3);return}if(await enviarFormulario(e.target,e.submitter))showStep(3)};document.getElementById('form-step-4').onsubmit=async(e)=>{e.preventDefault();if(e.submitter.name==='continuar'&&!e.target.querySelector('[name=nome_formacao]').value){showStep(4);return}if(await enviarFormulario(e.target,e.submitter))showStep(4)};document.getElementById('form-step-5').onsubmit=async(e)=>{e.preventDefault();if(e.submitter.name==='continuar'&&!e.target.querySelector('[name=nome]').value){showStep(5);return}if(await enviarFormulario(e.target,e.submitter))showStep(5)};document.getElementById('form-step-6').onsubmit=async(e)=>{e.preventDefault();if(await enviarFormulario(e.target,e.submitter)){onboardingWrapper.style.display='none';document.getElementById('progress-bar-fixed-wrapper').style.display='none';mainInterface.style.display='block';goToTab(0)}}}else{onboardingWrapper.style.display='none';mainInterface.style.display='block'}
    });

    async function preencherSkill(nome, tipo) {
        // 1. Pegar o Token de Segurança (obrigatório no Django)
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // 2. Feedback Visual Rápido (Opcional: preenche os inputs só pra mostrar o que está acontecendo)
        const inputNome = document.getElementById('id_nome');
        const selectTipo = document.getElementById('id_tipo');
        if(inputNome) inputNome.value = nome;
        if(selectTipo) selectTipo.value = tipo;

        // 2. Montar os dados para envio
        const formData = new FormData();
        formData.append('nome', nome);
        formData.append('tipo', tipo);
        // Nota: Não enviamos 'continuar', então o backend entende como "Adicionar e Manter na página"

        try {
            // 4. Enviar para o Backend via AJAX
            const response = await fetch("{% url 'ajax_salvar_skill' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            });

            const data = await response.json();

            if (data.status === 'success') {
                // 5. SUCESSO: Adicionar o item na lista visualmente
                // A. Adiciona na lista do Onboarding (Visualização atual)
                adicionarNaListaVisual('lista-skills', data.skill_id, nome, tipo);

                // B. Adiciona na lista do PERFIL (Para quando trocar de aba)
                // O ID no perfil é 'hard-skills-container' ou 'soft-skills-container'
                const containerId = tipo === 'hard' ? 'hard-skills-container' : 'soft-skills-container';
                adicionarNaListaPerfil(containerId, data.skill_id, nome);
                
                // Limpa o input para o próximo
                if(inputNome) inputNome.value = "";
                
            } else if (data.message) {
                // Se for erro de duplicidade, avisa suavemente
                alert(data.message); 
            } else {
                console.error('Erro:', data);
                // Se der erro (ex: skill duplicada ou vazia), avisa o usuário
                // Mas como estamos clicando em tags pré-definidas, erros são raros.
            }

        } catch (error) {
            console.error('Erro de conexão:', error);
        }
    }

    // Função auxiliar para desenhar no Onboarding
    function adicionarNaListaVisual(containerId, id, nome, tipo) {
        const lista = document.getElementById(containerId);
        if (!lista) return;

        const novoItem = document.createElement('div');
        novoItem.style.cssText = "background: #161B22; border-left: 3px solid #BEF264; padding: 10px; margin-bottom: 5px; border-radius: 4px; color: #fff; animation: fadeIn 0.5s; display: flex; justify-content: space-between;";
        novoItem.innerHTML = `
            <div><strong>${nome}</strong> <span style='color:#8b949e; font-size:0.9rem;'>(${tipo === 'hard' ? 'Hard' : 'Soft'})</span></div>
            <span style='color:#4ade80;'>✓ Salvo</span>
        `;
        lista.prepend(novoItem); // Adiciona no topo
    }

    // Função auxiliar para desenhar na Aba Perfil (Tag estilo pílula)
    function adicionarNaListaPerfil(containerId, id, nome) {
        const lista = document.getElementById(containerId);
        if (!lista) return;

        // Cria a tag igual ao estilo do perfil
        const novaTag = document.createElement('span');
        novaTag.className = 'skill-tag';
        novaTag.id = `skill-${id}`; // Importante para poder remover depois
        novaTag.innerHTML = `${nome} <span class="remove-skill" onclick="removeSkill(${id})">×</span>`;
        
        // Verifica se a mensagem "Nenhuma habilidade" existe e remove ela
        const msgVazia = lista.querySelector('p');
        if (msgVazia && msgVazia.innerText.includes('Nenhuma')) {
            msgVazia.remove();
        }

        lista.appendChild(novaTag);
    }
</script>

{% endblock %}

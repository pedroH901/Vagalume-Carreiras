{% extends 'base.html' %}
{% load static %}

{% block title %}Meu Dashboard{% endblock %}

{% block content %}

<div id="progress-bar-fixed-wrapper" style="display: none;">
    <p id="progresso-texto">0%</p>
    <div class="progress-bar-wrapper"><div class="progress-bar-fill" id="progresso-barra"></div></div>
</div>

<div id="onboarding-wrapper" style="display: none;">
    
    <div class="onboarding-container" id="onboarding-step-1">
        <button class="btn-skip-onboarding" onclick="pularTudo()">Pular Onboarding</button>
        <h1 class="onboarding-title">Bem-vindo(a), <span style="color: #BEF264;">{{ user.first_name|default:'Candidato' }}</span>!</h1>
        <p class="onboarding-subtitle">Vamos configurar seu perfil para encontrarmos as melhores vagas.</p>
        <button id="btn-iniciar-onboarding" class="btn-save" style="width: auto; padding: 12px 40px;">Começar Agora</button>
    </div>

    <div class="onboarding-container" id="onboarding-step-2">
        <button class="btn-skip-onboarding" onclick="pularTudo()">Pular</button>
        <h1 class="onboarding-title">Resumo Profissional</h1>
        <p class="onboarding-subtitle">Conte um pouco sobre sua trajetória profissional.</p>
        <form id="form-step-2" action="{% url 'ajax_salvar_resumo' %}" method="POST" class="custom-form-style" novalidate>
            {% csrf_token %}
            <textarea name="resumo" style="min-height: 150px;" placeholder="Ex: Desenvolvedor com 3 anos de experiência...">{% if texto_resumo and texto_resumo != 'Nenhum resumo cadastrado.' %}{{ texto_resumo }}{% endif %}</textarea>
            <div style="text-align: right; margin-top: 20px;"><button type="submit" class="btn-save" style="width: auto;">Continuar</button></div>
        </form>
    </div>

    <div class="onboarding-container" id="onboarding-step-3">
        <button class="btn-skip-onboarding" onclick="pularTudo()">Pular</button>
        <h1 class="onboarding-title">Experiência</h1>
        <p class="onboarding-subtitle">Adicione suas experiências mais relevantes.</p>
        <form id="form-step-3" action="{% url 'ajax_salvar_experiencia' %}" method="POST" class="custom-form-style" novalidate>
            {% csrf_token %} {{ experiencia_form.as_p }}
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="button" class="btn-outline" onclick="avancarSemSalvar(3)" style="border:none; color:#64748b;">Pular etapa</button>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" name="salvar_outro" class="btn-outline">+ Outra</button>
                    <button type="submit" name="continuar" class="btn-save" style="width: auto;">Salvar e Continuar</button>
                </div>
            </div>
        </form>
        <div id="lista-experiencias" style="text-align: left; margin-top: 20px;"></div>
    </div>

    <div class="onboarding-container" id="onboarding-step-4">
        <button class="btn-skip-onboarding" onclick="pularTudo()">Pular</button>
        <h1 class="onboarding-title">Formação Acadêmica</h1>
        <p class="onboarding-subtitle">Cursos, graduações e certificações.</p>
        <form id="form-step-4" action="{% url 'ajax_salvar_formacao' %}" method="POST" class="custom-form-style" novalidate>
            {% csrf_token %} {{ formacao_form.as_p }}
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="button" class="btn-outline" onclick="avancarSemSalvar(4)" style="border:none; color:#64748b;">Pular etapa</button>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" name="salvar_outro" class="btn-outline">+ Outra</button>
                    <button type="submit" name="continuar" class="btn-save" style="width: auto;">Salvar e Continuar</button>
                </div>
            </div>
        </form>
        <div id="lista-formacoes" style="text-align: left; margin-top: 20px;"></div>
    </div>

    <div class="onboarding-container" id="onboarding-step-5">
        <button class="btn-skip-onboarding" onclick="pularTudo()">Pular</button>
        <h1 class="onboarding-title">Suas Skills</h1>
        <p class="onboarding-subtitle">Clique para adicionar rapidamente.</p>
        
        <form id="form-step-5" action="{% url 'ajax_salvar_skill' %}" method="POST" class="custom-form-style" novalidate>
            {% csrf_token %} 
            {{ skill_form.as_p }}
            
            <label class="sugestao-titulo">Sugestões Rápidas:</label>
            <div class="tag-cloud-box">
                <div class="skill-tag-btn" onclick="preencherSkill('Python', 'hard', this)">Python</div>
                <div class="skill-tag-btn" onclick="preencherSkill('Java', 'hard', this)">Java</div>
                <div class="skill-tag-btn" onclick="preencherSkill('JavaScript', 'hard', this)">JavaScript</div>
                <div class="skill-tag-btn" onclick="preencherSkill('SQL', 'hard', this)">SQL</div>
                <div class="skill-tag-btn" onclick="preencherSkill('React', 'hard', this)">React</div>
                <div class="skill-tag-btn" onclick="preencherSkill('Django', 'hard', this)">Django</div>
                <div class="skill-tag-btn" onclick="preencherSkill('Git', 'hard', this)">Git</div>
                <div class="skill-tag-btn" onclick="preencherSkill('Inglês', 'hard', this)">Inglês</div>
                <div class="tag-separator"></div>
                <div class="skill-tag-btn" onclick="preencherSkill('Liderança', 'soft', this)">Liderança</div>
                <div class="skill-tag-btn" onclick="preencherSkill('Comunicação', 'soft', this)">Comunicação</div>
                <div class="skill-tag-btn" onclick="preencherSkill('Proatividade', 'soft', this)">Proatividade</div>
            </div>

            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button type="submit" name="salvar_outro" class="btn-outline">+ Adicionar Manual</button>
                <button type="submit" name="continuar" class="btn-save" style="width: auto;">Continuar</button>
            </div>
        </form>
        <div id="lista-skills" style="text-align: left; margin-top: 20px;"></div>
    </div>

    <div class="onboarding-container" id="onboarding-step-6">
        <button class="btn-skip-onboarding" onclick="pularTudo()">Pular</button>
        <h1 class="onboarding-title">Currículo PDF</h1>
        <form id="form-step-6" action="{% url 'ajax_salvar_curriculo' %}" method="POST" enctype="multipart/form-data" class="custom-form-style" novalidate>
            {% csrf_token %} {{ curriculo_form.as_p }}
            <div style="text-align: right; margin-top: 20px;">
                <button type="submit" class="btn-save" style="width: auto;">Finalizar</button>
            </div>
        </form>
    </div>
</div>

<div id="main-interface" class="dashboard-window">
    
    <section class="hero" id="dynamic-hero">
        <h1 id="hero-title">Olá, <span class="username">{{ user.first_name|default:user.username }}</span></h1>
        <p id="hero-subtitle">Confira as vagas recomendadas para você.</p>
        
        {% if messages %}
            {% for message in messages %}
                {% if 'FIRST_LOGIN' not in message.tags %}
                    <div class="popup-info">{{ message }}</div>
                {% endif %}
            {% endfor %}
        {% endif %}
    </section>

    <div class="tabs" id="tabs-container">
        <button class="tab active" onclick="goToTab(0)">Recomendados</button>
        <button class="tab" onclick="goToTab(1)">Perfil</button>
        <button class="tab" onclick="goToTab(2)">Finança</button>
        <div class="tab-indicator" id="tab-indicator"></div>
    </div>

    <div class="dashboard-slider show-tab-0" id="slider">
        
        <div class="panel active-panel">
            <div class="container">
                <div class="jobs-grid">
                    {% for vaga in vagas %}
<div class="job-card">
    <div class="tags">
        <span class="tag">{{ vaga.tipo_contrato }}</span>
        <span class="tag">{{ vaga.localidade }}</span>
    </div>
    
    <h3 class="job-title">{{ vaga.titulo }}</h3>
    
    <a href="{% url 'ver_empresa' vaga.empresa.id %}" class="company-link">
        <i class="fas fa-building"></i> {{ vaga.empresa.nome }}
    </a>

    <div class="job-card-footer">
        <a href="{% url 'ver_vaga_detalhe' vaga.id %}" class="btn-ver-mais" style="border: 1px solid #30363d; color: #fff; text-decoration: none; border-radius: 6px;">
            Ver Detalhes
        </a>

        <form action="{% url 'aplicar_vaga' vaga.id %}" method="POST" style="margin:0;">
            {% csrf_token %}
            <button class="apply-btn" style="width: 100%; border-radius: 6px;">
                Candidatar-se
            </button>
        </form>
    </div>
</div>
                    {% empty %}<p style="color:#8b949e; grid-column: 1/-1; text-align: center; padding: 40px;">Nenhuma vaga encontrada.</p>
                    
                    {% if vagas.has_other_pages %}
<div class="pagination-container" style="margin-top: 30px;">
    <div class="pagination">
        {% if vagas.has_previous %}
            <a href="?page=1" class="page-btn first" title="Primeira">&laquo;</a>
            <a href="?page={{ vagas.previous_page_number }}" class="page-btn">Anterior</a>
        {% endif %}

        <span class="current-page">
            {{ vagas.number }} / {{ vagas.paginator.num_pages }}
        </span>

        {% if vagas.has_next %}
            <a href="?page={{ vagas.next_page_number }}" class="page-btn">Próxima</a>
            <a href="?page={{ vagas.paginator.num_pages }}" class="page-btn last" title="Última">&raquo;</a>
        {% endif %}
    </div>
</div>
{% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="perfil-container">
                <div class="perfil-box">
                    <h2>Editar Dados</h2>
                    <form method="POST" class="perfil-form dashboard-ajax-form">
                        {% csrf_token %}
                        {% if perfil_user_form %}{{ perfil_user_form.as_p }}{% else %}<label>Nome</label><input type="text" name="first_name" value="{{ user.first_name }}"><label>Sobrenome</label><input type="text" name="last_name" value="{{ user.last_name }}">{% endif %}
                        {% if perfil_candidato_form %}{{ perfil_candidato_form.as_p }}{% else %}<label>Headline</label><input type="text" name="headline" value="{{ user.candidato.headline }}">{% endif %}
                        <button type="submit" class="btn-save">Salvar Alterações</button>
                    </form>
                </div>

                <div class="perfil-box">
                    <h2>Visualização do Currículo</h2>
                    <div style="text-align: center;">
                        <button onclick="pedirAnaliseIA()" class="btn-ia-glow">✨ Vagalume AI: Analisar meu Perfil</button>
                    </div>
                    
                    <div class="cv-section">
                        <h3>Resumo Profissional</h3>
                        <div class="edit-hint">Clique para editar</div>
                        <div class="cv-content" id="resumo-content" data-field="resumo">{{ texto_resumo|default:"Clique para adicionar um resumo." }}</div>
                        <div class="save-cancel-btns" id="resumo-actions">
                            <button class="btn-save" onclick="saveResumo()" style="padding:6px 15px; width:auto;">Salvar</button>
                            <button class="btn-cancel" onclick="cancelEdit('resumo')" style="padding:6px 15px; width:auto;">Cancelar</button>
                        </div>
                    </div>

                    <div class="cv-section">
                        <h3>Habilidades (Hard)</h3>
                        <div id="hard-skills-container" class="skill-list">
                            {% for skill in hard_skills %}
                                <span class="skill-tag" id="skill-{{ skill.id }}">{{ skill.nome }} <span class="remove-skill" onclick="removeSkill({{ skill.id }})">×</span></span>
                            {% endfor %}
                        </div>
                        <div class="add-skill-trigger" onclick="toggleSkillInput('hard')">+ Adicionar skill</div>
                        
                        <div class="skill-input-wrapper" id="hard-skill-input" style="flex-direction: column; align-items: stretch; display: none; margin-top: 15px;">
                            <div style="display: flex; gap: 10px;">
                                <input type="text" class="skill-input" placeholder="Digite ou selecione..." id="hard-skill-name">
                                <button class="add-skill-btn" onclick="addSkill('hard')">Salvar</button>
                            </div>
                            <div class="tag-cloud" style="margin-top: 10px;">
                                <small style="color: #8b949e; display: block; margin-bottom: 5px;">Sugestões:</small>
                                <span onclick="preencherSkillPerfil('hard', 'Python')">Python</span>
                                <span onclick="preencherSkillPerfil('hard', 'Java')">Java</span>
                                <span onclick="preencherSkillPerfil('hard', 'SQL')">SQL</span>
                            </div>
                        </div>
                    </div>

                    <div class="cv-section">
                        <h3>Habilidades (Soft)</h3>
                        <div id="soft-skills-container" class="skill-list">
                            {% for skill in soft_skills %}
                                <span class="skill-tag" id="skill-{{ skill.id }}">{{ skill.nome }} <span class="remove-skill" onclick="removeSkill({{ skill.id }})">×</span></span>
                            {% endfor %}
                        </div>
                        <div class="add-skill-trigger" onclick="toggleSkillInput('soft')">+ Adicionar skill</div>
                        
                        <div class="skill-input-wrapper" id="soft-skill-input" style="flex-direction: column; align-items: stretch; display: none; margin-top: 15px;">
                            <div style="display: flex; gap: 10px;">
                                <input type="text" class="skill-input" placeholder="Digite ou selecione..." id="soft-skill-name">
                                <button class="add-skill-btn" onclick="addSkill('soft')">Salvar</button>
                            </div>
                            <div class="tag-cloud" style="margin-top: 10px;">
                                <small style="color: #8b949e; display: block; margin-bottom: 5px;">Sugestões:</small>
                                <span onclick="preencherSkillPerfil('soft', 'Liderança')">Liderança</span>
                                <span onclick="preencherSkillPerfil('soft', 'Comunicação')">Comunicação</span>
                            </div>
                        </div>
                    </div>

                    <div class="cv-section">
                        <h3>Experiência Profissional</h3>
                        <div id="experiencias-container">
                            {% for exp in experiencias %}
                                <div class="xp-item" id="xp-{{ exp.id }}">
                                    <div style="float:right;"><button class="action-btn delete" onclick="deleteItem('experiencia', {{ exp.id }})">Excluir</button></div>
                                    <strong>{{ exp.cargo }}</strong>
                                    <span>{{ exp.empresa }} | {{ exp.data_inicio|date:"Y" }}</span>
                                    <p>{{ exp.descricao|default:"" }}</p>
                                </div>
                            {% empty %}<span class="cv-content">Nenhuma experiência registrada.</span>{% endfor %}
                        </div>
                        <button class="add-new-btn" onclick="abrirModal('modal-experiencia')"><span>+</span> Adicionar experiência</button>
                    </div>
                    
                    <div class="cv-section">
                        <h3>Formação Acadêmica</h3>
                        <div id="formacoes-container">
                            {% for edu in formacoes %}
                                <div class="edu-item" id="edu-{{ edu.id }}">
                                    <div style="float:right;"><button class="action-btn delete" onclick="deleteItem('formacao', {{ edu.id }})">Excluir</button></div>
                                    <strong>{{ edu.nome_formacao }}</strong>
                                    <span>{{ edu.nome_instituicao }} ({{ edu.nivel }})</span>
                                </div>
                            {% empty %}<span class="cv-content">Nenhuma formação registrada.</span>{% endfor %}
                        </div>
                        <button class="add-new-btn" onclick="abrirModal('modal-formacao')"><span>+</span> Adicionar formação</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="finance-controls">
                <button class="btn-pill" onclick="abrirModal('modal-calculadora')">Calculadora de Salário Líquido</button>
                <button class="btn-pill" onclick="abrirModalInfo('Orçamento')">Dicas de Orçamento</button>
                <button class="btn-pill" onclick="abrirModalInfo('Benefícios')">Benefícios Trabalhistas</button>
            </div>
            <div class="finance-grid">
                <div class="finance-card" onclick="abrirModalInfo('Primeiro Salário')"><ul><li>Como organizar o primeiro salário</li></ul></div>
                <div class="finance-card" onclick="abrirModalInfo('Emergência')"><ul><li>Planejamento para emergências</li></ul></div>
                <div class="finance-card" onclick="abrirModalInfo('Contracheque')"><ul><li>Entendendo descontos no contracheque</li></ul></div>
                <div class="finance-card" onclick="abrirModalInfo('FGTS')"><ul><li>Guia rápido sobre FGTS e 13º</li></ul></div>
            </div>
        </div>
    </div>
</div>

<div id="modal-experiencia" class="modal-overlay"><div class="modal-box"><div class="modal-header"><h3>Nova Experiência</h3><button class="btn-close-modal" onclick="fecharModal('modal-experiencia')">&times;</button></div><form action="{% url 'ajax_salvar_experiencia' %}" method="POST" class="modal-form dashboard-ajax-form">{% csrf_token %} {{ experiencia_form.as_p }}<div style="text-align: right;"><button type="submit" class="btn-save">Salvar</button></div></form></div></div>
<div id="modal-formacao" class="modal-overlay"><div class="modal-box"><div class="modal-header"><h3>Nova Formação</h3><button class="btn-close-modal" onclick="fecharModal('modal-formacao')">&times;</button></div><form action="{% url 'ajax_salvar_formacao' %}" method="POST" class="modal-form dashboard-ajax-form">{% csrf_token %} {{ formacao_form.as_p }}<div style="text-align: right;"><button type="submit" class="btn-save">Salvar</button></div></form></div></div>
<div id="modal-ia-result" class="modal-overlay">
    <div class="modal-box" style="border: 2px solid #BEF264; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
        
        <div class="modal-header" style="flex-shrink: 0;">
            <h3 style="color:#BEF264">✨ Análise Vagalume AI</h3>
            <button class="btn-close-modal" onclick="fecharModal('modal-ia-result')">&times;</button>
        </div>
        
        <div id="ia-content" style="color: #c9d1d9; line-height: 1.6; font-size: 1rem; text-align: left; overflow-y: auto; padding-right: 10px; margin-top: 10px;">
            </div>

        <div style="margin-top: 20px; text-align: right; flex-shrink: 0; border-top: 1px solid #30363d; padding-top: 15px;">
            <button onclick="fecharModal('modal-ia-result')" class="btn-save" style="width: auto;">Entendi</button>
        </div>

    </div>
</div>
<div id="modal-calculadora" class="modal-overlay"><div class="modal-box"><div class="modal-header"><h3>Calculadora</h3><button class="btn-close-modal" onclick="fecharModal('modal-calculadora')">&times;</button></div><div class="modal-form"><label>Salário Bruto</label><input type="number" id="calc-bruto"><label>Dependentes</label><input type="number" id="calc-dep"><button class="btn-save" onclick="calcularSalario()" style="margin-top:20px; width:100%;">Calcular</button><div id="calc-resultado" class="calc-result" style="display:none; margin-top:15px;">Líquido: <span id="valor-liquido"></span></div></div></div></div>
<div id="modal-info-financa" class="modal-overlay"><div class="modal-box"><div class="modal-header"><h3 id="info-title"></h3><button class="btn-close-modal" onclick="fecharModal('modal-info-financa')">&times;</button></div><div id="info-content" style="color:#c9d1d9; line-height:1.6;"></div></div></div>

<script>
    // --- FUNÇÕES DE COOKIE E TOKEN ---
    function getCookie(name){let cookieValue=null;if(document.cookie&&document.cookie!==''){const cookies=document.cookie.split(';');for(let i=0;i<cookies.length;i++){const cookie=cookies[i].trim();if(cookie.substring(0,name.length+1)===(name+'=')){cookieValue=decodeURIComponent(cookie.substring(name.length+1));break}}}return cookieValue}
    const csrftoken = getCookie('csrftoken');

    // --- ONBOARDING ---
    const mainInterface=document.getElementById('main-interface'), onboardingWrapper=document.getElementById('onboarding-wrapper');
    const steps = Array.from(document.querySelectorAll('.onboarding-container'));
    
    function showStep(index){
        steps.forEach((s,i)=>{
            s.style.display = i===index ? 'flex' : 'none';
            if(i===index) s.classList.add('container-ativo'); else s.classList.remove('container-ativo');
        });
        const pct=Math.round(((index+1)/steps.length)*100);
        const bar=document.getElementById('progresso-barra'); if(bar) bar.style.width=pct+'%';
        const txt=document.getElementById('progresso-texto'); if(txt) txt.innerText=pct+'%';
    }

    function finalizarOnboarding() {
        onboardingWrapper.style.display = 'none';
        document.getElementById('progress-bar-fixed-wrapper').style.display = 'none';
        mainInterface.style.display = 'block';
        const notif = document.createElement('div'); notif.className = 'popup-info'; notif.innerText = "Perfil configurado!";
        document.body.appendChild(notif); setTimeout(() => notif.remove(), 4000);
        window.location.reload();
        goToTab(0);
    }
    
    function pularTudo() { if(confirm("Pular configuração inicial?")) finalizarOnboarding(); }
    function avancarSemSalvar(curr) { if(curr < 5) showStep(curr); else finalizarOnboarding(); }

    async function enviarFormulario(form, btn){
        const formData = new FormData(form);
        if(btn) formData.append(btn.name, btn.value);
        try{
            const res = await fetch(form.action, {method:'POST', body:formData, headers:{'X-CSRFToken':csrftoken}});
            const data = await res.json();
            if(data.status==='success'){
                if(data.action==='next_step') return true; 
                const lista=document.getElementById(data.list_id);
                if(lista && data.saved_item_html) lista.innerHTML += data.saved_item_html;
                form.reset(); return false;
            } else {
                if(btn && btn.name==='continuar') return true; // Pular se der erro
                alert("Preencha os campos."); return false;
            }
        } catch(e){ return false; }
    }

    // Inicialização Onboarding
    let isFirstLogin=false;
    {% if messages %}{% for message in messages %}{% if 'FIRST_LOGIN' in message.tags %}isFirstLogin=true;{% endif %}{% endfor %}{% endif %}
    
    if(isFirstLogin){
        mainInterface.style.display='none';
        document.getElementById('progress-bar-fixed-wrapper').style.display='block';
        onboardingWrapper.style.display='block';
        showStep(0);
        document.getElementById('btn-iniciar-onboarding').onclick=()=>showStep(1);
        steps.forEach((step, idx) => {
            const form = step.querySelector('form');
            if(form) form.onsubmit = async(e) => {
                e.preventDefault();
                if(await enviarFormulario(e.target, e.submitter)) {
                    if(idx+1 < steps.length) showStep(idx+1); else finalizarOnboarding();
                }
            };
        });
    } else {
        onboardingWrapper.style.display='none';
        mainInterface.style.display='block';
    }

    // --- SKILLS ---
    async function preencherSkill(nome, tipo, el) {
        const inNome = document.getElementById('id_nome');
        const selTipo = document.getElementById('id_tipo');
        if(inNome) inNome.value = nome;
        if(selTipo) selTipo.value = tipo;

        const fd = new FormData(); fd.append('nome', nome); fd.append('tipo', tipo);
        try {
            const res = await fetch("{% url 'ajax_salvar_skill' %}", {method:'POST', headers:{'X-CSRFToken':csrftoken}, body:fd});
            const data = await res.json();
            if(data.status==='success'){
                adicionarNaListaVisual('lista-skills', data.skill_id, nome, tipo);
                const cId = tipo==='hard'?'hard-skills-container':'soft-skills-container';
                adicionarNaListaPerfil(cId, data.skill_id, nome);
                if(el) el.style.display='none';
                if(inNome) inNome.value='';
            } else if(data.message) alert(data.message);
        } catch(e){console.error(e);}
    }

    function adicionarNaListaVisual(cId, id, nome, tipo) {
        const l = document.getElementById(cId); if(!l) return;
        const div = document.createElement('div');
        div.style.cssText = "background: #161B22; border-left: 3px solid #BEF264; padding: 10px; margin-bottom: 5px; border-radius: 4px; color: #fff; display:flex; justify-content:space-between;";
        div.innerHTML = `<div><strong>${nome}</strong> <span style='color:#8b949e;'>(${tipo})</span></div><span style='color:#4ade80;'>✓ Salvo</span>`;
        l.prepend(div);
    }
    function adicionarNaListaPerfil(cId, id, nome) {
        const c = document.getElementById(cId); if(!c) return;
        const tag = document.createElement('span'); tag.className='skill-tag'; tag.id=`skill-${id}`;
        tag.innerHTML=`${nome} <span class="remove-skill" onclick="removeSkill(${id})">×</span>`;
        const p = c.querySelector('p'); if(p && p.innerText.includes('Nenhuma')) p.remove();
        c.appendChild(tag);
    }
    
    // Funções de Skill Manual na Aba Perfil
    function toggleSkillInput(type) {
        const w = document.getElementById(type + '-skill-input');
        if (w.style.display === 'none' || w.style.display === '') {
            w.style.display = 'flex'; setTimeout(() => document.getElementById(type + '-skill-name').focus(), 100);
        } else w.style.display = 'none';
    }
    async function addSkill(type) {
        const input = document.getElementById(type + '-skill-name'); const nome = input.value; if (!nome) return;
        const fd = new FormData(); fd.append('nome', nome); fd.append('tipo', type);
        try {
            const res = await fetch("{% url 'ajax_salvar_skill' %}", {method: 'POST', headers: {'X-CSRFToken': csrftoken}, body: fd});
            const data = await res.json();
            if (data.status === 'success') {
                adicionarNaListaPerfil(type==='hard'?'hard-skills-container':'soft-skills-container', data.skill_id, nome);
                input.value = ''; input.focus();
            } else alert(data.message);
        } catch (e) {}
    }
    function preencherSkillPerfil(type, nome) { document.getElementById(type + '-skill-name').value = nome; }

    // --- TABS ---
    let currentTab=0;
    function goToTab(index){
        if(index===currentTab)return;
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        document.querySelectorAll('.tab')[index].classList.add('active');
        document.getElementById('tab-indicator').style.left = (index * 33.33) + '%';
        document.getElementById('slider').style.transform = `translateX(-${index*33.33}%)`;
        document.querySelectorAll('.panel').forEach((p,i)=> i===index ? p.classList.add('active-panel') : p.classList.remove('active-panel'));
        currentTab=index;
    }
    document.querySelectorAll('.tab').forEach((t,i)=>t.addEventListener('click',()=>goToTab(i)));
    
    // --- MODAIS/IA ---
    function abrirModal(id) { const m=document.getElementById(id); m.style.display='flex'; setTimeout(()=>m.classList.add('active'),10); }
    function fecharModal(id) { const m=document.getElementById(id); m.classList.remove('active'); setTimeout(()=>m.style.display='none',300); }
    window.onclick=e=>{if(e.target.classList.contains('modal-overlay')) fecharModal(e.target.id);}
    
    async function pedirAnaliseIA(){
        const btn=document.querySelector('.btn-ia-glow'); const txt=btn.innerHTML;
        btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Analisando...'; btn.disabled=true;
        try{
            const res=await fetch("{% url 'ajax_analise_ia_perfil' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken}});
            const data=await res.json();
            if(data.status==='success'){ document.getElementById('ia-content').innerHTML=data.dicas; abrirModal('modal-ia-result'); }
            else alert("Ops: "+data.message);
        } catch(e){alert("Erro IA.");}
        finally{btn.innerHTML=txt; btn.disabled=false;}
    }

    // --- FINANÇAS ---
    const infoData={'Orçamento':'<p>Regra 50-30-20...</p>','Benefícios':'<p>VT, VR...</p>','Primeiro Salário':'<p>Priorize dívidas...</p>','Emergência':'<p>3 a 6 meses...</p>','Contracheque':'<p>INSS, IRRF...</p>','FGTS':'<p>8% salário...</p>'};
    function abrirModalInfo(k){document.getElementById('info-title').innerText=k; document.getElementById('info-content').innerHTML=infoData[k]||"Indisponível"; abrirModal('modal-info-financa');}
    function calcularSalario(){const b=parseFloat(document.getElementById('calc-bruto').value),d=parseInt(document.getElementById('calc-dep').value)||0;if(!b)return;let i=0;if(b<=1412)i=b*0.075;else if(b<=2666)i=b*0.09-21.18;else if(b<=4000)i=b*0.12-101.18;else if(b<=7786)i=b*0.14-181.18;else i=908.85;let bi=b-i-(d*189.59),ir=0;if(bi>2259){if(bi<=2826)ir=bi*0.075-169.44;else if(bi<=3751)ir=bi*0.15-381.44;else if(bi<=4664)ir=bi*0.225-662.77;else ir=bi*0.275-896.00}if(ir<0)ir=0;document.getElementById('valor-liquido').innerText=(b-i-ir).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});document.getElementById('calc-resultado').style.display='block';}

    // --- EDIÇÃO GERAL ---
    async function saveResumo(){const val=document.getElementById('resumo-textarea').value;const fd=new FormData();fd.append('resumo',val);try{const r=await fetch("{% url 'ajax_salvar_resumo' %}",{method:'POST',headers:{'X-CSRFToken':csrftoken},body:fd});if(r.ok){document.getElementById('resumo-content').innerText=val;cancelEdit('resumo')}}catch(e){}}
    function makeEditable(f){const c=document.getElementById(f+'-content'),a=document.getElementById(f+'-actions');if(c.style.display==='none')return;const t=document.createElement('textarea');t.id=f+'-textarea';t.className='editable-textarea';t.value=c.innerText.trim();c.style.display='none';c.parentNode.insertBefore(t,c.nextSibling);a.style.display='flex';t.focus()}
    function cancelEdit(f){const t=document.getElementById(f+'-textarea'),c=document.getElementById(f+'-content'),a=document.getElementById(f+'-actions');if(t)t.remove();c.style.display='block';a.style.display='none'}
    if(document.getElementById('resumo-content')) document.getElementById('resumo-content').addEventListener('click',()=>makeEditable('resumo'));
    async function removeSkill(id){if(!confirm("Remover?"))return;try{await fetch(`/contas/ajax/deletar-skill/${id}/`,{method:'DELETE',headers:{'X-CSRFToken':csrftoken}});document.getElementById('skill-'+id).remove()}catch(e){}}
    async function deleteItem(t,id){if(!confirm("Excluir?"))return;const url=type==='experiencia'?`/contas/ajax/deletar-experiencia/${id}/`:`/contas/ajax/deletar-formacao/${id}/`;try{const r=await fetch(url,{method:'DELETE',headers:{'X-CSRFToken':csrftoken}});if(r.ok)document.getElementById((t==='experiencia'?'xp-':'edu-')+id).remove()}catch(e){}}

    // --- CORREÇÃO DO BUG JSON (EVENT DELEGATION) ---
    // Em vez de procurar o form, escutamos qualquer submit na página e filtramos
    document.body.addEventListener('submit', async function(e) {
        if (e.target.classList.contains('dashboard-ajax-form')) {
            e.preventDefault(); // AGORA O PREVENT DEFAULT FUNCIONA SEMPRE
            const f = e.target;
            const fd = new FormData(f);
            const btn = f.querySelector('button[type="submit"]');
            const txt = btn.innerText;
            btn.innerText = "Salvando..."; btn.disabled = true;
            
            try {
                const res = await fetch(f.action, {
                    method: 'POST', 
                    body: fd, 
                    headers: {'X-CSRFToken': csrftoken}
                });
                
                if (res.ok) {
                    window.location.reload();
                } else {
                    alert('Erro ao salvar (verifique os campos).');
                    btn.innerText = txt; 
                    btn.disabled = false;
                }
            } catch (error) {
                alert("Erro de conexão.");
                btn.innerText = txt; 
                btn.disabled = false;
            }
        }
    });
</script>

{% endblock %}